<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DashboardScreen</title>
    <link rel="icon" type="image/png" href="../assets/favicon.png">
</head>
<link rel="stylesheet" href="../css/donationStats.css">
<body>
    <div id="eventwrapper">
        <header id="logined-nav">
            <div class="logo"> <img src="../assets/website-logo.png" alt="EcoImpact logo" > </div> <!--Logo nav page-->
            <nav>
                <div class="nav">
                    <a href="#"><i class="fa-regular fa-bell fa-xl"></i></a>
                    <a href="homePage.html">Home</a>
                    <a  href="event.html">Event</a>
                    <a id = "currentpage" href="#">Donate</a>
                    <a href="FeedbackResponse.html" id = "contactus">Contact</a>
                    <a href="#">Account</a>
                </div>
            </nav>
            
        </header>
    </div>
<div style="max-width: 7xl; margin: auto; width: 100%; padding-bottom: 8ch;background-color: rgba(247,248,252,255);border: 0.01px solid transparent;">
  <!-- Header -->
  <div style="max-width: 7xl; margin: auto; width: 100%;">
    <!-- Header -->
    <div onclick = "back()" class="back-button">Back</div>
    <div id="header-container">
        <h2>Donation Statistics</h2>
    </div>
    </div>
    <!-- <div style="display: flex; gap: 0.5rem;">
      <svg style="height: 1.25rem; width: 1.25rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span>Jon Oh</span>
    </div> -->


  <!-- Donation Overview -->
  <div style="background-color: rgba(247,248,252,255); border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); padding: 1.5rem; gap: 1.5rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <!-- <div style="display: flex; align-items: center; gap: 0.5rem;">
            <svg style="height: 2rem; width: 2rem; color: #667eea;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12H4"/><path d="M12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/><path d="M4.93 4.93 19.07 19.07"/></svg>
            <h3 style="font-size: 1.125rem; font-weight: 600;">Total Donations</h3>
        </div> -->
        <!-- <span style="font-size: 1.875rem; font-weight: 700;">$8,500</span> -->
    </div>
    <div style="padding: 1.5rem; gap: 5rem;" class="stat-holder">
      <div class="stat-card">
          <span>Number of Donations</span>
          <span id="number-of-donations">Loading...</span>
      </div>
      <div class="stat-card">
          <span>Average Donation</span>
          <span id="average-donation">Loading...</span>
      </div>
      <div class="stat-card">
          <span>Total Donations</span>
          <span id="total-donations">Loading...</span>
      </div>
      <div class="stat-card">
          <span>Largest Single Donation</span>
          <span id="largest-single-donation">Loading...</span>
      </div>
  </div>
    </div>
</div>

  <!-- Donation Charts -->
  <div style="gap: 1.5rem;">
    <div style="background-color: rgba(247,248,252,255); border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); padding: 1rem; gap: 1rem;">
      <h3 style="font-size: 2rem; font-weight: 600; margin-bottom: 0.75rem;">Donation Trend</h3>
      <div style="height: 40rem;">
        <select id="timeFilter">
          <option value="hour">Hour</option>
          <option value="day">Day</option>
          <option value="month">Month</option>
          <option value="year">Year</option>
      </select>
        <canvas id="donationLineChart"></canvas>
        <svg>
          <defs>
            <linearGradient id="colorUv" x1="0" y1="0" x2="0" y2="1">
              <stop offset="5%" stop-color="#667eea" stop-opacity="0.8"/>
              <stop offset="95%" stop-color="#667eea" stop-opacity="0"/>
            </linearGradient>
          </defs>
          <g>
            <!-- XAxis and YAxis structure -->
            <g>
              <!-- Tooltip structure -->
              <!-- Area structure -->
            </g>
          </g>
        </svg>
      </div>
    </div>

    <div style="background-color: rgba(247,248,252,255); border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); padding: 1rem; gap: 1rem;">
      <h3 style="font-size: 2rem; font-weight: 600; margin-bottom: 0.75rem;">Donation Sources</h3>
      <div style="height: 30rem;" >
        <!-- PieChart component structure -->
            <canvas id="donationPieChart"></canvas>
      </div>     
    </div>
  </div>


  <!-- Recent Donations -->
  <div style="grid-column: span 2; background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">
    <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #E5E7EB; padding: 1rem;">
      <h3 style="font-size: 1.125rem; font-weight: 600;">Recent Donations</h3>
      <button style="background-color: #667eea; color: white; padding: 0.3rem 0.75rem; border-radius: 0.375rem; cursor: pointer;">View All</button>
    </div>
    <div style="border-top: 1px solid #e5e7eb;">
      <div style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;">
        <div>
          <span style="font-size: 0.875rem; color: #6B7280;">4:37 AM</span>
          <p style="font-size: 0.875rem;">Received $100 donation from John Smith</p>
          <p style="font-size: 0.875rem; color: #6B7280;">
            <span>Source: <svg style="display: inline; height: 1rem; width: 1rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="14" x="3" y="7" rx="2" ry="2"/><path d="M16 1v6M8 1v6m-5 9h14a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v0a2 2 0 0 1 2-2z"/></svg> Credit Card</span>
          </p>
        </div>
        <div style="text-align: right;">
          <p style="font-size: 0.875rem;">John Smith</p>
          <p style="font-size: 0.875rem;">$100</p>
        </div>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;">
        <div>
          <span style="font-size: 0.875rem; color: #6B7280;">2:14 AM</span>
          <p style="font-size: 0.875rem;">Received $50 donation from Lisa Johnson</p>
          <p style="font-size: 0.875rem; color: #6B7280;">
            <span>Source: <svg style="display: inline; height: 1rem; width: 1rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10.29A15.3 15.3 0 0 1 12 22c-1.38 0-2.71-.18-4-.53"/></svg> Website</span>
          </p>
        </div>
        <div style="text-align: right;">
          <p style="font-size: 0.875rem;">Lisa Johnson</p>
          <p style="font-size: 0.875rem;">$50</p>
        </div>
      </div>
      
      <div style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;">
        <div>
          <span style="font-size: 0.875rem; color: #6B7280;">12:59 AM</span>
          <p style="font-size: 0.875rem;">Received $25 donation from Michael Lee</p>
          <p style="font-size: 0.875rem; color: #6B7280;">
            <span>Source: <svg style="display: inline; height: 1rem; width: 1rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="6" r="1"/><path d="M12 10v4l2 2"/></svg> Globe</span>
          </p>
        </div>
        <div style="text-align: right;">
          <p style="font-size: 0.875rem;">Michael Lee</p>
          <p style="font-size: 0.875rem;">$25</p>
        </div>
      </div>
      
      <div style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;">
        <div>
          <span style="font-size: 0.875rem; color: #6B7280;">Yesterday at 4:37 PM</span>
          <p style="font-size: 0.875rem;">Received $75 donation from Emily Davis</p>
          <p style="font-size: 0.875rem; color: #6B7280;">
            <span>Source: <svg style="display: inline; height: 1rem; width: 1rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="14" x="3" y="7" rx="2" ry="2"/><path d="M16 1v6M8 1v6m-5 9h14a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v0a2 2 0 0 1 2-2z"/></svg> Credit Card</span>
          </p>
        </div>
        <div style="text-align: right;">
          <p style="font-size: 0.875rem;">Emily Davis</p>
          <p style="font-size: 0.875rem;">$75</p>
        </div>
      </div>
      
      <div style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;">
        <div>
          <span style="font-size: 0.875rem; color: #6B7280;">Yesterday at 10:22 AM</span>
          <p style="font-size: 0.875rem;">Received $30 donation from David Wilson</p>
          <p style="font-size: 0.875rem; color: #6B7280;">
            <span>Source: <svg style="display: inline; height: 1rem; width: 1rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10.29A15.3 15.3 0 0 1 12 22c-1.38 0-2.71-.18-4-.53"/></svg> Website</span>
          </p>
        </div>
        <div style="text-align: right;">
          <p style="font-size: 0.875rem;">David Wilson</p>
          <p style="font-size: 0.875rem;">$30</p>
        </div>
      </div>
      
      <div style="display: flex; justify-content: space-between; padding: 0.75rem 1rem;">
        <div>
          <span style="font-size: 0.875rem; color: #6B7280;">June 3</span>
          <p style="font-size: 0.875rem;">Received $20 donation from Sarah Brown</p>
          <p style="font-size: 0.875rem; color: #6B7280;">
            <span>Source: <svg style="display: inline; height: 1rem; width: 1rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12H4"/><path d="M12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/><path d="M4.93 4.93 19.07 19.07"/></svg> Gift</span>
          </p>
        </div>
        <div style="text-align: right;">
          <p style="font-size: 0.875rem;">Sarah Brown</p>
          <p style="font-size: 0.875rem;">$20</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
//IMPORTANT, for authentication
const token = localStorage.getItem("token");
console.log(token);
function back(){
  window.location.href = "donationPage.html"
}
document.addEventListener('DOMContentLoaded', (event) => {
    fetchDonationData();
    initializeRealTimeLineChart();
    fetchDonationStatistics();
});

const timeFilter = document.getElementById('timeFilter');
timeFilter.addEventListener('change', function() {
    const filter = timeFilter.value;
    console.log(filter);
    fetchRealTimeDonationData(filter);
});
async function fetchDonationStatistics(){
      const response = await fetch("http://localhost:3000/stats", {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
            }
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    const donations = await response.json();
    console.log(donations)
    console.log(donations[0].numberOfDonations)
    document.getElementById('number-of-donations').textContent = donations[0].numberOfDonations;
    document.getElementById('average-donation').textContent = `$${donations[0].averageDonation}`;
    document.getElementById('total-donations').textContent = `$${donations[0].totalDonations}`;
    document.getElementById('largest-single-donation').textContent = `$${donations[0].largestSingleDonation}`;

}
async function fetchDonationData() {
    try{
        const response = await fetch("http://localhost:3000/donations", {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
            }
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const donations = await response.json();
        console.log(donations)
            const companyNames = donations.map(donation => donation.company);
            const donationAmounts = donations.map(donation => donation.amount);

            const companyTotals = {};
            companyNames.forEach((company, index) => {
                if (!companyTotals[company]) {
                    companyTotals[company] = 0;
                }
                companyTotals[company] += donationAmounts[index];
            });

            const labels = Object.keys(companyTotals);
            const values = Object.values(companyTotals);

            createPieChart(labels, values);
          } catch{
            console.error('Error fetching donation data:', error);
          }
}

function createPieChart(labels, values) {
    const ctx = document.getElementById('donationPieChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            let total = values.reduce((sum, val) => sum + val, 0);
                            let percentage = ((values[tooltipItem.dataIndex] / total) * 100).toFixed(2);
                            return `${labels[tooltipItem.dataIndex]}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
}

let donationLineChart;

function initializeRealTimeLineChart() {
    const ctx = document.getElementById('donationLineChart').getContext('2d');
    donationLineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Donation Amount',
                data: [],
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true,
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day' // Default unit
                    },
                    adapters: {
                        date: {
                            locale: 'en',
                            timezone: 'UTC'
                        }
                    },
                    min: null,
                    max: null
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    fetchRealTimeDonationData('day'); // Fetch initial data
}

function fetchRealTimeDonationData(filter) {
    fetch('http://localhost:3000/donations')
        .then(response => response.json())
        .then(data => {
            let labels, amounts;

            // Aggregate data based on the filter
            ({ labels, amounts } = aggregateDataByFilter(data, filter));

            // Update chart data
            donationLineChart.data.labels = labels;
            donationLineChart.data.datasets[0].data = amounts;

            // Adjust the time range displayed on the x-axis
            const timeRange = getTimeRangeForFilter(filter);
            const latestTime = labels[labels.length - 1].getTime();
            donationLineChart.options.scales.x.min = new Date(latestTime - timeRange);
            donationLineChart.options.scales.x.max = new Date(latestTime);

            // Update chart unit and format
            donationLineChart.options.scales.x.time.unit = getChartUnit(filter);
            donationLineChart.options.scales.x.time.tooltipFormat = getFormatOptions(filter);

            // Update the chart
            donationLineChart.update();
        })
        .catch(error => {
            console.error('Error fetching real-time donation data:', error);
        });
}

function aggregateDataByFilter(data, filter) {
    // Process data differently based on the selected filter (hour, day, month, year)
    let labels = [];
    let amounts = [];

    if (filter === 'hour') {
        // More detailed, frequent data points
        data.forEach(donation => {
            labels.push(new Date(donation.datetime));
            amounts.push(donation.amount);
        });
    } else if (filter === 'day') {
        // Aggregate data by day
        let dailyData = {};
        data.forEach(donation => {
            let date = new Date(donation.datetime);
            let dayKey = date.toISOString().split('T')[0];
            if (!dailyData[dayKey]) {
                dailyData[dayKey] = 0;
            }
            dailyData[dayKey] += donation.amount;
        });
        labels = Object.keys(dailyData).map(dateStr => new Date(dateStr));
        amounts = Object.values(dailyData);
    } else if (filter === 'month') {
        // Aggregate data by month
        let monthlyData = {};
        data.forEach(donation => {
            let date = new Date(donation.datetime);
            let monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = 0;
            }
            monthlyData[monthKey] += donation.amount;
        });
        labels = Object.keys(monthlyData).map(monthStr => new Date(monthStr + '-01'));
        amounts = Object.values(monthlyData);
    } else if (filter === 'year') {
        // Aggregate data by year
        let yearlyData = {};
        data.forEach(donation => {
            let date = new Date(donation.datetime);
            let yearKey = date.getFullYear();
            if (!yearlyData[yearKey]) {
                yearlyData[yearKey] = 0;
            }
            yearlyData[yearKey] += donation.amount;
        });
        labels = Object.keys(yearlyData).map(yearStr => new Date(yearStr + '-01-01'));
        amounts = Object.values(yearlyData);
    }

    return { labels, amounts };
}

function getTimeRangeForFilter(filter) {
    switch (filter) {
        case 'hour':
            return 24 * 60 * 60 * 1000; // Last 24 hours
        case 'day':
            return 30 * 24 * 60 * 60 * 1000; // Last 30 days
        case 'month':
            return 365 * 24 * 60 * 60 * 1000; // Last 12 months
        case 'year':
            return 10 * 365 * 24 * 60 * 60 * 1000; // Last 10 years
        default:
            return 30 * 24 * 60 * 60 * 1000; // Default to 30 days
    }
}

function getFormatOptions(filter) {
    switch (filter) {
        case 'hour':
            return 'MM-DD HH:mm'; 
        case 'day':
            return 'DD';       
        case 'month':
            return 'DD';         
        case 'year':
            return 'YYYY';             
        default:
            return 'YYYY-MM-DD';       
    }
}


function getChartUnit(filter) {
    switch (filter) {
        case 'hour':
            return 'hour';
        case 'day':
            return 'day';
        case 'month':
            return 'month';
        case 'year':
            return 'year';
        default:
            return 'day';
    }
}

initializeRealTimeLineChart(); // Call this function to initialize the chart


</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
</body>
</html>