<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Nav Bar</title>
    <link rel="stylesheet" href="../css/viewDonations.css">
    <link rel="icon" type="image/png" href="../assets/favicon.png">
    <script src="https://kit.fontawesome.com/4aa858a7fc.js" crossorigin="anonymous"></script>
    <style>
        /* Inline style for demonstration purpose */
    </style>
</head>
<body>
    <div id="eventwrapper">
        <header id="logined-nav">
            <div class="logo"> <img src="../assets/website-logo.png" alt="EcoImpact logo" > </div> <!--Logo nav page-->
            <nav>
                <div class="nav">
                    <a href="#"><i class="fa-regular fa-bell fa-xl"></i></i></a>
                    <a href="#">Home</a>
                    <a href="#">Event</a>
                    <a id="currentpage" href="#">Donate</a>
                    <a href="#" id="contactus">Contact</a>
                    <a href="#">Account</a>
                </div>
            </nav>
        </header>
    </div>
    <div id = "title">My Donations</div>
    <div id="donationContainer"></div>
    <div id = "backButton">Back</div>

    <script>
        const accountType = localStorage.getItem('accountType');
        const username = localStorage.getItem('username');
        const token = localStorage.getItem('token');
        document.getElementById('backButton').addEventListener('click', function() {
            window.location.href = "donationPage.html";
        });

        function formatDateTime(datetimeStr) {
            const date = new Date(datetimeStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const year = String(date.getFullYear()).slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        async function fetchDonations() {
            try {
                const response = await fetch(`http://localhost:3000/donations`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
            });
                const donations = await response.json();
                console.log('All Donations:', donations); // Debugging
                if (Array.isArray(donations)) {
                    const donationContainer = document.getElementById('donationContainer');
                    donations.forEach(donation => {
                        const formattedDateTime = formatDateTime(donation.datetime);
                        const donationBox = document.createElement('div');
                        donationBox.classList.add('donation-box');
                        donationBox.innerHTML = `
                            <div class="donation-info">
                                <div class="donation-amount-company">
                                    <div class="donation-amount">$${donation.amount}</div>
                                    <div class="donation-company">to ${donation.company}</div>
                                </div>
                            </div>
                            <div class="donation-datetime">${formattedDateTime}</div>
                            <div class="view-more-button">View More</div>
                        `;
                        donationContainer.appendChild(donationBox);
                    });
                } else {
                    console.error('Error: Donations data is not an array');
                }
            } catch (error) {
                console.error('Error fetching donations:', error);
            }
        }

        async function fetchUserDonations() {  
            try{ 
            const response = await fetch(`http://localhost:3000/donations/${username}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
            });
                const donations = await response.json();
                console.log('User Donations:', donations); // Debugging
                if (Array.isArray(donations)) {
                    const donationContainer = document.getElementById('donationContainer');
                    donations.forEach(donation => {
                        const formattedDateTime = formatDateTime(donation.datetime);
                        const donationBox = document.createElement('div');
                        donationBox.classList.add('donation-box');
                        donationBox.innerHTML = `
                            <div class="donation-info">
                                <div class="donation-amount-company">
                                    <div class="donation-amount">$${donation.amount}</div>
                                    <div class="donation-company">to ${donation.company}</div>
                                </div>
                            </div>
                            <div class="donation-datetime">${formattedDateTime}</div>
                            <div class="view-more-button">View More</div>
                        `;
                        donationContainer.appendChild(donationBox);
                    });
                } else {
                    console.error('Error: User donations data is not an array');
                }
            } catch (error) {
                console.error('Error fetching donations:', error);
            }
        }

        if (accountType === 'Staff') {
            window.onload = fetchDonations;
        } else {
            window.onload = fetchUserDonations;
        }
    </script>
</body>
</html>
